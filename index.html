<html>
<head>
<script type="text/javascript">
var worker;
var canvas;
var ctx;
var buffer = 0;

function init() {
	canvas = document.getElementById('widget0');
	ctx = canvas.getContext('2d');
	if ( worker == undefined ) {
		console.log('creating a new worker');
		worker = new Worker("animation.js");

		worker.addEventListener('message', function(e) {
			var data = e.data;
			var oldStyle = ctx.strokeStyle;
			switch(data.cmd) {
				case 'log':
					console.log(data.msg);
					break;
				case 'drawArc':
					{
						ctx.strokeStyle = data.stroke;
						ctx.beginPath();
						ctx.arc(data.x, data.y, data.radius, data.startAngle, data.endAngle, data.anticlockwise);
						ctx.stroke();
						ctx.strokeStyle = oldStyle;
					}
					break;
				case 'drawLine':
					{
						ctx.strokeStyle = data.stroke;
						ctx.beginPath();
						ctx.moveTo(data.startx, data.starty);
						ctx.lineTo(data.stopx, data.stopy);
						ctx.stroke();
						ctx.strokeStyle = oldStyle;
					}
					break;
				case 'clearCanvas':
					var oldCanvas = canvas;
					canvas = document.getElementById('widget'+buffer);
					ctx = canvas.getContext('2d');
					canvas.style.display = "none";
					oldCanvas.style.display = "block";
					clearCanvas();
					buffer ? buffer = 0 : buffer = 1;
					break;
			}
		});
	}

	worker.postMessage({'cmd': 'setDimensions', 'w': canvas.width, 'h': canvas.height});
	worker.postMessage({'cmd': 'setM', 'value': document.getElementById('M').value});
	worker.postMessage({'cmd': 'setN', 'value': document.getElementById('n').value});
	worker.postMessage({'cmd': 'setA', 'value': document.getElementById('A').value});
	worker.postMessage({'cmd': 'init'});
}

function start() {
	worker.postMessage({'cmd': 'start'});
}

function stop() {
	worker.postMessage({'cmd': 'stop'});
}

function resetWidget() {
	worker.terminate();
	delete worker;
	worker = undefined;
	clearCanvas();
	init();
}

function clearCanvas() {
	oldStyle = ctx.fillStyle;
	ctx.fillStyle = "rgba(255, 255, 255, 255)";
	ctx.fillRect(0, 0, canvas.width, canvas.height);
	ctx.fillStyle = oldStyle;
}

function setM(value) {
	if ( typeof(value) !== 'number' )
		value = parseInt(value);

	worker.postMessage({'cmd': 'setM', 'value': value});

	if ( parseInt(document.getElementById('A').value) > Math.floor(value/2))
		setA(Math.floor(value/2));
	document.getElementById('A').setAttribute('max', Math.floor(value/2));

	document.getElementById('M').value = value;
	document.getElementById('Mtext').value = value;
}

function setN(value) {
	worker.postMessage({'cmd': 'setN', 'value': value});
	document.getElementById('n').value = value;
	document.getElementById('Ntext').value = value;
}

function setA(value) {
	worker.postMessage({'cmd': 'setA', 'value': value});
	document.getElementById('A').value = value;
	document.getElementById('Atext').value = value;
}

function noop() {
}
</script>
</head>
<body onload="init();">
<form method="get" action="javascript: noop();" >
<div>
<canvas id="widget0" width="500px" height="500px" style="border: 1px solid black;">Canvas not supported!</canvas>
<canvas id="widget1" width="500px" height="500px" style="border: 1px solid black; display: none;">Canvas not supported!</canvas>
</div>
<div>
<button onclick="start();">run</button>
<button onclick="stop();">stop</button>
<button onclick="resetWidget();">reset</button>
</div>
<div>
<table>
<tr>
<td>
<label label-for="M">M:</label>
</td>
<td>
<input id="M" type="range" min="5" max="25" value="20" onchange="setM(this.value)" />
</td>
<td>
<input id="Mtext" type="text" value="20" size="5" onchange="setM(this.value)" />
</td>
</tr>
<tr>
<td>
<label label-for="n">n:</label>
</td>
<td>
<input id="n" type="range" min="100" max="10000" value="1000" step="10" onchange="setN(this.value)" />
</td>
<td>
<input id="Ntext" type="text" value="1000" size="5" onchange="setN(this.value)" />
</td>
</tr>
<tr>
<td>
<label label-for="A">A:</label>
</td>
<td>
<input id="A" type="range" min="1" max="10" value="10" onchange="setA(this.value)" />
</td>
<td>
<input id="Atext" type="text" value="10" size="5" onchange="setA(this.value)" />
</td>
</tr>
</table>
</form>
</body>
</html>
