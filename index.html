<html>
<head>
<script type="text/javascript" src="utils.js"></script>
<script type="text/javascript" src="block.js"></script>
<script type="text/javascript" src="segment.js"></script>
<script type="text/javascript" src="car.js"></script>
<script type="text/javascript">
M = 20;
n = 2000;
run = false;

function highlightBlock(block, canvas, strokeStyle) {
	Segments[block.topSegment()].drawSegment(canvas, strokeStyle);
	Segments[block.leftSegment()].drawSegment(canvas, strokeStyle);
	Segments[block.bottomSegment()].drawSegment(canvas, strokeStyle);
	Segments[block.rightSegment()].drawSegment(canvas, strokeStyle);
}

function init(){
var canvas = document.getElementById('widget');
Segments = new Array(2*Math.pow(M,2));
for (i = 0; i < Segments.length; i++)
{
	Segments[i] = new Segment(M, i);
}
drawGrid(canvas);

Blocks = new Array(Math.pow(M,2));
for (i=0; i < Blocks.length; i++)
{
	Blocks[i] = new Block(i, M);
}

Vehicles = new Array(n);
for (i = 0; i < n; i+=2)
{
	var home = Math.floor(Math.random()*(Math.pow(M,2)));
	var c1 = new Car(home, M);
	if ( c1.tier < 10 ) console.log(c1.tier);
	Vehicles[i] = c1;
	var b1 = Blocks[c1.home];
	var s1 = Segments[b1.tier(c1.tier, Blocks).segments[c1.segment]];
	s1.drawCar(canvas);
	var c2 = new Car(home, M);
	if ( c2.tier < 10 ) console.log(c2.tier);
	Vehicles[i+1] = c2;
	var b2 = Blocks[c2.home];
	var s2 = Segments[b2.tier(c2.tier, Blocks).segments[c2.segment]];
	s2.drawCar(canvas);
}
//animate();
};

function drawGrid(canvas) {
	for (i = 0; i < Segments.length; i++)
		Segments[i].drawSegment(canvas);
}

function animate() {
	canvas = document.getElementById('widget');
	clearCanvas();
	drawGrid(canvas);
	for (i=0; i < Vehicles.length; i++)
	{
		Vehicles[i].move();
		s = Segments[Vehicles[i].getSegment()];
		if ( !s )
			console.log(i + ": " + Vehicles[i].getSegment());
		s.drawCar(canvas, i==0 ? "red" : null);
	}
	if ( run )
		window.setTimeout(function() { animate() }, 1000);
}

function clearCanvas() {
	var canvas = document.getElementById('widget');
	if (canvas.getContext)
	{
		var ctx = canvas.getContext('2d');

		oldStyle = ctx.fillStyle;
		ctx.fillStyle = "rgba(255, 255, 255, 255)";
		ctx.fillRect(0, 0, canvas.width, canvas.height);
		ctx.fillStyle = oldStyle;
	}

};

function noop() {
}

function start() {
	if (!run)
	{
		run = true;
		animate();
	}
}

function stop() {
	if (run)
		run = false;
}
</script>
</head>
<body onload="init();">
<form method="get" action="javascript: noop();" >
<div>
<canvas id="widget" width="500px" height="500px" style="border: 1px solid black;">Canvas not supported!</canvas>
</div>
<div>
<button onclick="start();">run</button>
<button onclick="stop();">stop</button>
</div>
</form>
</body>
</html>
